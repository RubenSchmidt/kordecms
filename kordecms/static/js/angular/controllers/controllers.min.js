kordeCms.controller("ArticlesCtrl",["$scope","PageFactory","ArticleFactory","UserFactory","GlobalEditorService",function($scope,PageFactory,ArticleFactory,UserFactory,GlobalEditorService){$scope.editorMode=true;$scope.publishedText=function(article){return article.isPublished?"Publisert":"Ikke publisert"};$scope.isTextElement=function(element){return element.type==1};$scope.getColumnClass=function(element){var classString="";classString+=element.width_type==1?"col-md-12":"col-md-6";classString+=element.type==1?" text-element":" image-element";return classString};ArticleFactory.list().then(function(response){$scope.articles=response.data;console.log(response.data)},function(response){})}]);kordeCms.controller("DashboardCtrl",["$scope","ArticleFactory","PageFactory",function($scope,ArticleFactory,PageFactory){ArticleFactory.count().then(function success(response){var data=response.data;$scope.articles={};$scope.articles.published=data.article_count_p;$scope.articles.unpublished=data.article_count_u},function error(){console.log("Something went wrong!")});PageFactory.list().then(function success(response){$scope.pages=response.data;console.log($scope.pages)},function error(response){$scope.error=response.data});$scope.editorMode=true}]);kordeCms.controller("EditArticleCtrl",["$scope","$routeParams","PageFactory","ArticleFactory","UserFactory","GlobalEditorService",function($scope,$routeParams,PageFactory,ArticleFactory,UserFactory,GlobalEditorService){$scope.editorMode=true;$scope.newTagInput={};$scope.article={};initNewElement();var isNew=true;function initNewElement(){$scope.newElement={type:0,width_type:0,image_src:""}}if(!$routeParams.articleId){isNew=true;console.log("New article mode")}else{ArticleFactory.get($routeParams.articleId).then(function(response){$scope.article=response.data;isNew=false;console.log(response.data)},function(response){console.log(response)})}$scope.pageHeader=function(){return isNew?"Skriv en ny artikkel":"Rediger artikkel"};$scope.addArticleElement=function(){if($scope.newElement.type){$scope.newElement.text="Skriv noe her!..."}$scope.article.elements.push(angular.copy($scope.newElement));initNewElement()};$scope.saveArticle=function(){if(isNew){createArticle()}else{ArticleFactory.update($scope.article).then(function(response){},function(response){console.log(response)})}};var createArticle=function(){if(!$scope.article.title){}else if(!$scope.article.body){console.log("Error in create article: "+response)}else{ArticleFactory.create($scope.article).then(function(response){$scope.article={}},function(response){console.log(response);$scope.errors})}};$scope.addTag=function(article){var list=article.tag_string.split(",");var id=article.id.toString();if(list.indexOf($scope.newTagInput[id])<0&&$scope.newTagInput[id]){article.tag_string+=article.tag_string.length>0?","+$scope.newTagInput[id]:$scope.newTagInput[id];$scope.newTagInput[id]="";ArticleFactory.update(article).then(function(response){},function(response){console.log(response)})}};$scope.deleteTag=function(tag_name,article){var list=article.tag_string.split(",");var index=list.indexOf(tag_name);if(index>-1){list.splice(index,1)}article.tag_string=list.join();ArticleFactory.update(article).then(function(response){},function(response){console.log(response)})};$scope.upload=function(file){$scope.article.thumbnail_image_src=file.name;console.log(file)}}]);kordeCms.controller("EditUserCtrl",["$scope","$routeParams","$location","$http","UserFactory",function($scope,$routeParams,$location,$http,UserFactory){UserFactory.get($routeParams.userId).then(function(response){$scope.user=response.data},function(response){});UserFactory.currentUser($routeParams.userId).then(function(response){$scope.currentUser=response.data},function(response){});$scope.canEditUser=function(user){return user.id==$scope.currentUser.id||$scope.currentUser.is_superuser};var updateUser=function(){return user.id!=$scope.currentUser.id&&$scope.currentUser.is_superuser};$scope.updateUser=function(){updateUser()};var updateUser=function(){if($scope.user){UserFactory.update($scope.user).then(function(response){$location.path("/users")},function(response){$scope.errors=response.data})}else{$scope.errors={username:["Dette feltet er p책krevd"],password:["Dette feltet er p책krevd"]}}};$scope.password={old_password:"",new_password_1:"",new_password_2:""};$scope.updatePassword=function(){updatePassword()};var updatePassword=function(){if($scope.password.new_password_1==$scope.password.new_password_2){$http.post("/api/api-token-auth/",{username:$scope.user.username,password:$scope.password.old_password}).then(function(response){if(response.status===200&&response.data.token){$scope.user.password=$scope.password.new_password_2;UserFactory.updatePassword($scope.user).then(function(response){$location.path("/users")},function(response){$scope.errors=response.data;console.log($scope.errors)})}},function(response){$scope.errors=response.data;console.log(response.data)})}else{$scope.errors={newPassword:["Forskjellig passord oppgitt"]}}}}]);kordeCms.controller("LoginCtrl",["$scope","$location","AuthService","$timeout",function($scope,$location,AuthService,$timeout){$scope.loading=false;$scope.login=function(){$scope.loading=true;AuthService.login($scope.username,$scope.password).then(function(response){$timeout(function(){$scope.loading=false;$location.path("/")},1e3)},function(response){$scope.loading=false;$scope.errors=response.data})}}]);kordeCms.controller("NavbarCtrl",["$scope","$location","$route","AuthService","SweetAlert",function($scope,$location,$route,AuthService,SweetAlert){$scope.showNavbar=false;$scope.$on("$routeChangeStart",function(next,current){$scope.showNavbar=current.$$route.originalPath!=="/login"});$scope.logout=function(){SweetAlert.swal({title:"Vil du logge ut?",showCancelButton:true,confirmButtonText:"Ja",cancelButtonText:"Nei",closeOnConfirm:true},function(isConfirm){if(isConfirm){AuthService.logout();$location.path("/login");$route.reload()}})}}]);kordeCms.controller("NewUserCtrl",["$scope","$location","UserFactory",function($scope,$location,UserFactory){$scope.saveUser=function(){createUser()};var createUser=function(){if($scope.user){$scope.user.is_staff=true;UserFactory.create($scope.user).then(function(response){$location.path("/users")},function(response){$scope.errors=response.data})}else{$scope.errors={username:["Dette feltet er p책krevd"],password:["Dette feltet er p책krevd"]}}}}]);kordeCms.controller("PageElementCtrl",["$scope","$routeParams","GlobalEditorService","PageElementFactory","SweetAlert",function($scope,$routeParams,GlobalEditorService,PageElementFactory,SweetAlert){$scope.editorMode=true;PageElementFactory.get($routeParams.id).then(function(response){$scope.element=response.data;console.log(response.data)},function(response){});$scope.updateElement=function(){if($scope.file){upload($scope.file)}else{PageElementFactory.update($scope.element).then(function success(response){SweetAlert.swal({title:"Lagret",type:"success",showConfirmButton:false,timer:1e3})},function error(response){console.log(response)})}};$scope.setFile=function(file){$scope.file=file};$scope.checkType=function(check,answer){return check===answer};var upload=function(file){$scope.element.image_src=file;PageElementFactory.updateImageElement($scope.element,file).then(function(response){console.log("Success "+response.config.data.file.name+"uploaded. Response: "+response.data);SweetAlert.swal({title:"Lagret",type:"success",showConfirmButton:false,timer:1e3});$scope.element=response.data},function(response){console.log("Error status: "+response.status)},function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);console.log("progress: "+progressPercentage+"% "+evt.config.data.file.name)})}}]);kordeCms.controller("UsersCtrl",["$scope","$filter","SweetAlert","UserFactory",function($scope,$filter,SweetAlert,UserFactory){$scope.getRole=function(user){if(user.is_superuser){return"Admin"}else{return"Bruker"}};$scope.deleteUser=function(user){SweetAlert.swal({title:"Vil du slette "+user.username+"?",showCancelButton:true,confirmButtonText:"Ja",cancelButtonText:"Nei",closeOnConfirm:true},function(isConfirm){if(isConfirm){if(UserFactory.destroy(user.id)){$scope.users=$filter("filter")($scope.users,{id:"!"+user.id})}}})};$scope.canEditUser=function(user){return user.id==$scope.currentUser.id||$scope.currentUser.is_superuser};$scope.canDeleteUser=function(user){return user.id!=$scope.currentUser.id&&$scope.currentUser.is_superuser};UserFactory.currentUser().then(function success(response){$scope.currentUser=response.data},function(response){});UserFactory.list().then(function(response){$scope.users=response.data},function(response){})}]);kordeCms.controller("EditPageCtrl",["$scope","$routeParams","PageFactory","Upload",function($scope,$routeParams,PageFactory,Upload){$scope.page={};PageFactory.get($routeParams.pageSlug).then(function(response){$scope.page=response.data;PageFactory.listElements($scope.page.slug).then(function(response){$scope.pageElements=response.data},function(response){$scope.error=response.data})},function(response){$scope.error=response.data})}]);kordeCms.controller("PagesCtrl",["$scope","PageFactory","ArticleFactory","UserFactory",function($scope,PageFactory,ArticleFactory,UserFactory){PageFactory.list().then(function(response){console.log(response.data);$scope.pages=response.data},function(response){$scope.error=response.data})}]);